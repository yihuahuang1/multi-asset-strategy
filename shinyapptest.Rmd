---
output: html_document
runtime: shiny
---
# Section 2 Interactive Output Page {-}

#https://rstudio.github.io/DT/
#https://bookdown.org/yihui/rmarkdown/shiny-deploy.html#shinyapps.io

```{r message=FALSE, warning=FALSE, include=FALSE}
# Load necessary libraries
library(shiny)
library(plotly)
library(DT)
library(dplyr)
library(ggplot2)

# Data Intake
mega7data = read.csv("mega7tidy.csv")
mega7mcap = read.csv("mega7marketcap.csv")

mega7data_modified <- 
  mega7data %>%
  inner_join(mega7mcap, join_by(symbol == Stock)) %>%
  rename(market_cap = Marketcap) %>%
  select(!X.x) %>% 
  select(!X.y) 
```

```{r}
# Load necessary libraries

# Define UI
ui22 <- fluidPage(
    titlePanel("Section 2 Interactive Output Webpage"),
    
    
    sidebarLayout(
        sidebarPanel(
            selectInput("symbol", "Symbol", choices = unique(mega7data_modified$symbol)),
            dateRangeInput("dateRange", "Date Range", 
                           start = min(mega7data_modified$date), end = max(mega7data_modified$date)),
            checkboxGroupInput("variables", "Variables", 
                               choices = c("adjusted" = "adjusted", "close", "high", "low", "open",
                                           "volume"="volume","market_cap"="market cap"),
                               selected = c("adjusted","volume"))
        ),
        mainPanel(
          tabsetPanel(
            tabPanel("Data Table", DTOutput("table")),
            tabPanel("Price Chart", plotlyOutput("pricePlot")),
            tabPanel("Volume Chart", plotlyOutput("volumePlot"))
          )
        )
    )
)

# Define server logic
server22 <- function(input, output) {
    # Reactive expression for filtered data for the table
    filteredData <- reactive({
        req(input$symbol, input$dateRange)
        mega7data_modified %>%
            filter(symbol == input$symbol, date >= input$dateRange[1], 
                   date <= input$dateRange[2]) %>%
            select(date, symbol, all_of(input$variables)) %>%
          arrange(desc(date))
    })
    # Reactive expression for filtered data for the graphs
  filteredGraphData <- reactive({
    req(input$symbol, input$dateRange)
    data <- mega7data_modified %>%
      filter(symbol == input$symbol, date >= input$dateRange[1], date <= input$dateRange[2]) %>%
      select(date, adjusted, volume)  # Always include price and volume for the graphs
    data$date <- as.Date(data$date)
    data
    })
    # Render the table
    output$table <- renderDT({
      datatable(
        filteredData(), 
        options = list(pageLength = 10, autoWidth = TRUE),
        caption = htmltools::tags$caption(style = "caption-side: top; font-size: 250%;",
                                          "Stock Price/Volume Data (raw)")) %>%
        formatRound(columns = which(names(filteredData()) %in% input$variables), digits = 2) %>%
        formatStyle("volume", fontWeight = "bold",
                    `data-thousands` = ",", `data-type` = "formatted-num") %>%
        formatRound(columns = which(names(filteredData()) == "volume"), digits = 0) %>%
        formatStyle("adjusted", fontWeight = "bold")
    })
  # Render the plot
    output$pricePlot <- renderPlotly({
        # Assuming you are plotting price and volume for simplicity
        data <- filteredGraphData()

        # Constructing the graph (example with ggplot2 and plotly)
        p <- ggplot(data, aes(x = date, y = adjusted)) +
            geom_line(color = 'blue') +
            scale_x_date(date_breaks = "3 month", date_labels = "%b %Y") +
            ggtitle(paste("Stock Price for", input$symbol)) +
            xlab("Date") + 
            ylab("Adjusted Close Price (USD)") + 
            theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
            theme_bw()

        ggplotly(p)
    })
    output$volumePlot <- renderPlotly({
        data <- filteredGraphData()
        req(data$volume)

        v <- ggplot(data, aes(x = date, y = volume)) +
            geom_bar(stat = 'identity', fill = 'deepskyblue3') +
            scale_x_date(date_breaks = "3 month", date_labels = "%b %Y") +
            ggtitle(paste("Volume for", input$symbol)) +
            xlab("Date") +
            ylab("Volume in USD") +
            theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
            theme_minimal()

        ggplotly(v)
    })
}

# Run the application 
shinyApp(ui22, server22)

```












